# v0.5 - Multi-tenant con Sistema de Invitaciones

**Fecha de lanzamiento**: Enero 2026
**URL de producci√≥n**: https://www.diariodeuninstante.com

---

## üéØ Resumen Ejecutivo

v0.5 transforma Diario de un Instante de un blog personal a una **plataforma multi-tenant** donde m√∫ltiples usuarios pueden tener sus propios diarios, con control total sobre qu√© contenido hacer p√∫blico o privado.

**Caracter√≠sticas clave**:
- ‚úÖ Multi-tenant completo con aislamiento de datos
- ‚úÖ Sistema de invitaciones exclusivo
- ‚úÖ Home global muestra contenido p√∫blico de todos los usuarios
- ‚úÖ Panel admin personalizado para cada usuario
- ‚úÖ Roles de usuario (Admin/User)
- ‚úÖ Sistema de solicitudes de invitaci√≥n

---

## ‚úÖ Features Implementadas

### 1. Core Multi-tenant

#### Autenticaci√≥n
- [x] **Firebase Auth** con email/password
- [x] **P√°gina de Login**: `/login`
- [x] **P√°gina de Registro**: `/registro` (requiere c√≥digo de invitaci√≥n)
- [x] **Protected Routes**: Middleware para proteger rutas admin
- [x] **Persistencia de sesi√≥n**: Firebase Auth maneja sesiones autom√°ticamente

#### Users Collection
- [x] **Colecci√≥n `users`** en Firestore:
  ```typescript
  {
    uid: string,        // Firebase Auth UID
    email: string,
    displayName?: string,
    role: 'admin' | 'user',
    createdAt: Timestamp
  }
  ```
- [x] **Roles**: `admin` (puede generar invitaciones) y `user` (solo puede gestionar sus instantes)
- [x] **Perfil de usuario**: Cada usuario tiene su documento en Firestore

#### Aislamiento de Datos
- [x] **Campo `userId`** en cada instante
- [x] **Queries filtradas**:
  - `getInstantesByUser(userId)` - Solo instantes del usuario
  - `getGlobalPublicInstantes()` - Instantes p√∫blicos de TODOS los usuarios
  - `getGlobalPublicInstantesByArea(areaId)` - Por √°rea de todos los usuarios
- [x] **Verificaci√≥n de ownership**: Solo el due√±o puede editar sus instantes

---

### 2. Sistema de Invitaciones

#### C√≥digos de Invitaci√≥n
- [x] **Formato**: `XXXX-XXXX-XXXX` (3 segmentos de 4 caracteres)
- [x] **Caracteres sin ambig√ºedad**: Sin I, O, 0, 1
- [x] **Single-use**: Cada c√≥digo solo se puede usar una vez
- [x] **Tracking**: Fecha de creaci√≥n, qui√©n lo cre√≥, email del usuario (opcional), estado de uso

#### Colecci√≥n `invites`
```typescript
{
  code: string,          // XXXX-XXXX-XXXX
  email?: string,        // Opcional: restringir a un email
  used: boolean,
  usedBy?: string,       // UID del usuario que lo us√≥
  usedAt?: Timestamp,
  createdBy: string,     // UID del admin que lo cre√≥
  createdAt: Timestamp
}
```

#### Panel de Invitaciones (`/admin/invitaciones`)
- [x] **Solo visible para admins**
- [x] **Generar c√≥digos** con un clic
- [x] **Asignar a email** espec√≠fico (opcional)
- [x] **Ver estado**: Activo / Usado
- [x] **Ver historial**: Qui√©n us√≥ cada c√≥digo y cu√°ndo
- [x] **Copiar c√≥digo** al portapapeles

---

### 3. Sistema de Solicitudes de Invitaci√≥n

#### Formulario P√∫blico
- [x] **Secci√≥n en la home**: "¬øQuieres tu propio Diario de un Instante?"
- [x] **Campos**:
  - Nombre * (o c√≥mo le gustar√≠a que le llamen)
  - Email * (donde recibir√° el c√≥digo)
  - ¬øPor qu√© te interesa? (opcional)
- [x] **Validaci√≥n**: Campos obligatorios
- [x] **Feedback**: Mensaje de √©xito tras enviar

#### Colecci√≥n `invitation_requests`
```typescript
{
  name: string,
  email: string,
  reason?: string,
  status: 'pending' | 'approved' | 'rejected',
  createdAt: Timestamp,
  reviewedAt?: Timestamp,
  reviewedBy?: string,      // UID del admin que revis√≥
  inviteCodeSent?: boolean
}
```

#### Panel de Solicitudes (`/admin/solicitudes`)
- [x] **Solo visible para admins**
- [x] **Filtros**: Todas / Pendientes / Aprobadas / Rechazadas
- [x] **Ver detalles**: Nombre, email, raz√≥n
- [x] **Aprobar solicitud**: Genera c√≥digo autom√°ticamente
- [x] **Rechazar solicitud**: Marca como rechazada
- [x] **Copiar c√≥digo**: Portapapeles con un clic
- [x] **Marcar como enviado**: Trackea cu√°ndo se envi√≥ el c√≥digo al usuario

---

### 4. P√°ginas P√∫blicas (Globales)

#### Home (`/`)
- [x] **Muestra instantes p√∫blicos** de TODOS los usuarios
- [x] **Hero section**: T√≠tulo, descripci√≥n, bot√≥n al panel admin
- [x] **Estad√≠sticas globales**: Total de instantes, pensamientos, acciones, √°reas activas
- [x] **Grid de √°reas**: Muestra √°reas con √∫ltimo instante de todos los usuarios
- [x] **CTA**: "¬øQuieres tu propio Diario?" con formulario de solicitud

#### Archivo (`/archivo`)
- [x] **Timeline** con todos los instantes p√∫blicos de todos los usuarios
- [x] **Orden cronol√≥gico inverso**

#### √Åreas (`/trabajo`, `/salud`, etc.)
- [x] **Muestra instantes p√∫blicos** del √°rea de TODOS los usuarios
- [x] **Breadcrumb**: Inicio > √Årea
- [x] **Info del √°rea**: Emoji, nombre, total de instantes

#### Instante Individual (`/[area]/[slug]`)
- [x] **Muestra instante** si es p√∫blico
- [x] **Sin importar** el usuario que lo cre√≥

---

### 5. Panel Admin (Aislado por Usuario)

#### Dashboard (`/admin`)
- [x] **Solo instantes del usuario logueado**
- [x] **Filtros**: Todos / Borradores / Publicados / Privados
- [x] **Badges visuales**:
  - üìù Borrador (para `estado: 'borrador'`)
  - üîí Privado (para `privado: true`)
- [x] **Acciones**: Ver, Editar, Eliminar
- [x] **Responsive**: Tabla en escritorio, lista en m√≥vil

#### Crear Instante (`/admin/nuevo`)
- [x] **Campos**:
  - T√≠tulo *
  - Fecha *
  - √Årea *
  - Tipo (Pensamiento/Acci√≥n)
  - Slug (auto-generado)
  - Contenido (Markdown)
  - **Estado**: Borrador / Publicado (nuevo en v0.5)
  - **Privado**: S√≠ / No (nuevo en v0.5)
- [x] **Auto-guardado de userId** del usuario autenticado

#### Editar Instante (`/admin/editar/[id]`)
- [x] **Verificaci√≥n de ownership**: Solo el due√±o puede editar
- [x] **Carga todos los campos** del instante
- [x] **Actualiza userId** (manteniendo ownership)

#### Estad√≠sticas (`/admin/estadisticas`)
- [x] **Solo instantes del usuario**
- [x] **Gr√°ficos**: Pensamientos vs Acciones, instantes por √°rea

#### Configuraci√≥n (`/admin/configuracion`)
- [x] **Muestra info del usuario**:
  - ID de usuario
  - Email
  - Rol: üëë Administrador / üë§ Usuario
  - Miembro desde: Fecha de creaci√≥n
- [x] **No editable** (solo lectura en esta versi√≥n)

---

### 6. Men√∫ Responsive

#### Escritorio
- [x] **Navegaci√≥n horizontal**: Instantes, Nuevo, Estad√≠sticas, Invitaciones (solo admins), Solicitudes (solo admins), Configuraci√≥n, Ver blog
- [x] **Email del usuario** visible
- [x] **Bot√≥n "Cerrar sesi√≥n"**

#### M√≥vil
- [x] **Bot√≥n hamburguesa** (‚ò∞)
- [x] **Men√∫ desplegable** con todas las opciones
- [x] **Se cierra autom√°ticamente** al navegar
- [x] **Email y cerrar sesi√≥n** dentro del men√∫

---

### 7. Seguridad

#### Reglas de Firestore
```javascript
// Instantes: cualquiera puede leer, solo due√±o puede escribir
match /instantes/{instanteId} {
  allow read: if true;
  allow write: if request.auth != null && request.auth.uid == resource.data.userId;
}

// Users: usuario puede leer/escribir su propio perfil
match /users/{userId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
}

// Invites: usuarios autenticados pueden gestionar
match /invites/{inviteId} {
  allow read, write: if request.auth != null;
}

// Solicitudes: cualquiera puede crear, solo auth puede leer/actualizar
match /invitation_requests/{requestId} {
  allow create: if true;
  allow read, update: if request.auth != null;
}
```

#### Protecci√≥n de Rutas
- [x] **Middleware en layout** de admin: Redirige a `/login` si no est√° autenticado
- [x] **Rutas protegidas**: Todo bajo `/admin`
- [x] **P√°ginas de auth**: Marcadas con `export const dynamic = 'force-dynamic'` para evitar SSR

---

### 8. Migraci√≥n de Datos

#### Script de Migraci√≥n
- [x] **`scripts/migrate-user-id.ts`**:
  - A√±ade `userId` a instantes existentes
  - Asigna rol de `admin` al primer usuario
  - Backup autom√°tico antes de migrar

#### Manual en Firebase Console
- [x] **Gu√≠as paso a paso** en `PRODUCCION.md` e `INSTRUCCIONES-RAPIDAS.md`
- [x] **Usuario existente** puede convertirse en admin sin registrarse de nuevo

---

## üìÅ Archivos Principales

### Nuevo Core
- **`lib/auth.tsx`**: Sistema de autenticaci√≥n con roles, AuthProvider, useAuth hook
- **`lib/invites.ts`**: Gesti√≥n de c√≥digos de invitaci√≥n y solicitudes
- **`lib/firestore.ts`**: A√±adido `userId` a interfaces, funciones globales vs usuario

### P√°ginas de Auth
- **`app/(auth)/login/page.tsx`**: P√°gina de login
- **`app/(auth)/registro/page.tsx`**: P√°gina de registro con c√≥digo de invitaci√≥n

### Panel Admin
- **`app/admin/(dashboard)/invitaciones/page.tsx`**: Panel de gesti√≥n de c√≥digos (admin only)
- **`app/admin/(dashboard)/solicitudes/page.tsx`**: Panel de gesti√≥n de solicitudes (admin only)
- **`app/admin/(dashboard)/configuracion/page.tsx`**: Ver perfil y rol
- **`app/admin/(dashboard)/layout.tsx`**: Header con men√∫ responsive

### P√°ginas P√∫blicas (actualizadas)
- **`app/page.tsx`**: Home con formulario de solicitud
- **`app/archivo/page.tsx`**: Archivo global
- **`app/[area]/page.tsx`**: √Årea global

### Scripts
- **`scripts/migrate-user-id.ts`**: Migraci√≥n con rol de admin
- **`scripts/backup.ts`**: Backup de todos los datos

### Documentaci√≥n
- **`PRODUCCION.md`**: Gu√≠a paso a paso para producci√≥n
- **`INSTRUCCIONES-RAPIDAS.md`**: Gu√≠a r√°pida para usuarios existentes
- **`MIGRATION.md`**: Gu√≠a t√©cnica completa
- **`v0.5-RESUMEN.md`**: Resumen ejecutivo
- **`v0.5-CHANGELOG.md`**: Este archivo

---

## ‚ùå Features NO Implementadas (Futuras Versiones)

### v0.6 - Autenticaci√≥n Extendida
- [ ] **Google Auth**: Sign in with Google
- [ ] **Apple Auth**: Sign in with Apple
- [ ] **Magic Links**: Login sin contrase√±a
- [ ] **Recuperaci√≥n de contrase√±a**: Reset password por email

### v0.7 - Personalizaci√≥n de Blogs
- [ ] **Subdominios**: `username.diariodeuninstante.com`
- [ ] **P√°ginas de perfil**: `/@username` o `/u/username`
- [ ] **Configuraci√≥n de blog**:
  - [ ] Nombre del blog
  - [ ] Bio / Descripci√≥n
  - [ ] Foto de perfil
  - [ ] Foto de cabecera
  - [ ] Tema personalizado (colores)
- [ ] **Dominio personalizado**: Usuarios pueden conectar su propio dominio

### v0.8 - Monetizaci√≥n
- [ ] **Planes**: Free, Premium, Enterprise
- [ ] **L√≠mites**:
  - [ ] Free: 50 instantes
  - [ ] Premium: Ilimitados + dominio personalizado
- [ ] **Pagos**: Stripe integration
- [ ] **Trial**: 14 d√≠as gratis

---

## üîß Stack Tecnol√≥gico

### Core
- **Next.js 14**: App Router, Server/Client Components
- **React 18**: Hooks, Context
- **TypeScript**: Tipado estricto
- **Tailwind CSS**: Estilos responsive

### Firebase
- **Firebase Auth**: Autenticaci√≥n
- **Firestore**: Base de datos NoSQL
- **Firebase Security Rules**: Protecci√≥n de datos

### UI/UX
- **date-fns**: Formateo de fechas
- **Lucide React**: Iconos
- **React Markdown**: Renderizado de markdown

### DevOps
- **Vercel**: Hosting y deployment
- **Git**: Version control
- **GitHub**: Repositorio

---

## üìä M√©tricas de Producci√≥n

### URL
- **Producci√≥n**: https://www.diariodeuninstante.com
- **Panel admin**: https://www.diariodeuninstante.com/admin
- **Registro**: https://www.diariodeuninstante.com/registro

### Usuarios
- **Admin principal**: benitezl@go.ugr.es
- **Total instantes migrados**: 3
- **UserId**: M6NOUchI8yUv6pFWskPMhGkxfrP2

### Colecciones Firestore
1. **`instantes`**: Todos los instantes de todos los usuarios
2. **`users`**: Perfiles de usuario con roles
3. **`invites`**: C√≥digos de invitaci√≥n
4. **`invitation_requests`**: Solicitudes de invitaci√≥n

### √çndices Compuestos
- **`instantes`**: `userId` (asc) + `fecha` (desc)
- **`instantes`**: `area` (asc) + `fecha` (desc)

---

## üêõ Issues Conocidos

### Menores
- [ ] Warnings de React Hook dependencies (no cr√≠ticos)
- [ ] No hay validaci√≥n de unicidad de slugs globalmente (solo por usuario)

### Limitaciones
- [ ] M√°ximo 1 request por segundo en Firestore (free tier)
- [ ] Sin l√≠mite de instantes por usuario (se a√±adir√° en v0.8)

---

## üöÄ Pr√≥ximos Pasos

### Inmediatos
- [ ] Monitorear uso del sistema de solicitudes
- [ ] Recopilar feedback de primeros usuarios
- [ ] AjustarÊñáÊ°à del formulario si es necesario

### Corto Plazo (v0.6)
- [ ] Implementar Google Auth
- [ ] Implementar Apple Auth
- [ ] A√±adir reset de contrase√±a

### Medio Plazo (v0.7)
- [ ] Subdominios personalizados
- [ ] P√°ginas de perfil
- [ ] Configuraci√≥n de blog

### Largo Plazo (v0.8+)
- [ ] Sistema de pagos
- [ ] Planes con l√≠mites
- [ ] Dominios personalizados

---

## üìù Notas de Desarrollo

### Decisiones de Arquitectura

1. **Invitaciones obligatorias**: Para mantener la calidad y evitar spam
2. **P√°ginas globales vs user-specific**: Separaci√≥n clara entre p√∫blico y admin
3. **Rol de admin √∫nico**: El primer usuario es admin por defecto
4. **Sin subdominios a√∫n**: Requiere configuraci√≥n DNS adicional, pendiente para v0.7

### Lecciones Aprendidas

1. **√çndices compuestos**: Necesarios para queries con `where` + `orderBy`
2. **Reglas de Firestore**: Cruciales para la seguridad, testear extensivamente
3. **SSR vs Client**: Auth pages necesitan `dynamic = 'force-dynamic'`
4. **Migraci√≥n manual**: Para pocos instantes, es m√°s r√°pido que scripts

### Debt T√©cnico

1. [ ] A√±adir tests unitarios
2. [ ] A√±adir tests E2E con Playwright
3. [ ] Optimizar im√°genes (Next/Image)
4. [ ] A√±adir logging (Sentry o similar)

---

## ‚úÖ Checklist de Lanzamiento

- [x] Features core implementadas
- [x] Testing manual completado
- [x] Reglas de Firestore configuradas
- [x] √çndices compuestos creados
- [x] Migraci√≥n de datos completada
- [x] Usuario admin configurado
- [x] Deploy en Vercel exitoso
- [x] Home p√∫blica funcionando
- [x] Panel admin funcionando
- [x] Sistema de invitaciones funcionando
- [x] Sistema de solicitudes funcionando
- [x] Men√∫ responsive funcionando
- [x] Documentaci√≥n completa
- [x] Backup de datos

---

## üéâ Conclusi√≥n

**v0.5 est√° completa y en producci√≥n**.

Diario de un Instante es ahora una plataforma multi-tenant lista para escalar. El sistema de invitaciones permite crecer de forma controlada, manteniendo la calidad de la comunidad.

**Pr√≥ximos pasos**: Implementar Google/Apple Auth (v0.6) y personalizaci√≥n de blogs (v0.7).

---

**Versi√≥n**: 0.5.0
**Estado**: ‚úÖ Production Ready
**Fecha**: Enero 2026
**Autor**: Javier Ben√≠tez + Claude Sonnet 4.5
